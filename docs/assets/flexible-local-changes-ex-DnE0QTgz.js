var L=f=>{throw TypeError(f)};var V=(f,l,n)=>l.has(f)||L("Cannot "+n);var u=(f,l,n)=>(V(f,l,"read from private field"),n?n.call(f):l.get(f)),S=(f,l,n)=>l.has(f)?L("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(f):l.set(f,n),D=(f,l,n,e)=>(V(f,l,"write to private field"),e?e.call(f,n):l.set(f,n),n),p=(f,l,n)=>(V(f,l,"access private method"),n);var M=(f,l,n,e)=>({set _(t){D(f,l,t,n)},get _(){return u(f,l,e)}});import{C as z}from"./constraint-DeQkDHBu.js";import{S as T,A as x}from"./assignment-list-WRCWa3GG.js";var w,b,C,g,d,U,A,F,j,k,B,$,R;class J extends T{constructor(){super();S(this,d);S(this,w);S(this,b);S(this,C);S(this,g)}name(){return"Flexible Local Changes Ex"}preprocess(){[M(this,b)._,M(this,w)._]=p(this,d,U).call(this),D(this,C,this.pro.degree()),this.pro.emptyVariableSize()===0&&this.pro.clearAllVariables(),D(this,g,-1),this.monitor.initialize()}exec(){const n=new Set,e=new Set,t=new Set;for(const m of this.pro.variables())(m.isEmpty()?t:e).add(m);const a=new Set,i=p(this,d,B).call(this,e,a);let o,s=null;t.size===0?(o=i,s=x.fromVariables(e)):o=u(this,b);const r=p(this,d,A).call(this,e,a).union(t),c=e.difference(r);let h=p(this,d,F).call(this,n,c,r,u(this,w),u(this,w),o);return h<o&&s!==null&&s.apply(),h=this.pro.degree(),h>u(this,C)&&h>0&&(u(this,g)!==0||this.monitor.getTarget()===null)}}w=new WeakMap,b=new WeakMap,C=new WeakMap,g=new WeakMap,d=new WeakSet,U=function(){let n=1,e=0;for(const t of this.pro.variables())for(const a of t){const i=a.lowestConsistencyDegree(),o=a.highestConsistencyDegree();i<n&&(n=i),o>e&&(e=o)}return[n,e]},A=function(n,e){const t=new Map;for(const o of e)if(o.isDefined())for(const s of o)t.has(s)?t.set(s,(t.get(s)??0)+1):t.set(s,1);const a=[...n];a.sort((o,s)=>{let r=0,c=0;return t.has(o)&&(r=t.get(o)??0),t.has(s)&&(c=t.get(s)??0),r<c?1:r>c?-1:0});const i=new Set;for(const o of a){let s=!1;for(const r of e)if(r.isDefined()){s=!0;break}if(!s)break;o.clear(),i.add(o)}return i},F=function(n,e,t,a,i,o){for(e=new Set(e),t=new Set(t);;){this.monitor.outputDebugString(`X1 ${n.size}, X2' ${e.size}, X3' ${t.size}`);const s=this.monitor.check(this.pro.degree());if(s!==null)return D(this,g,s?1:0),i;if(t.size===0)return i;const r=t.values().next().value,c=p(this,d,j).call(this,n,e,r,a,i,o);if(u(this,g)!==-1)return i;if(c<o)return u(this,b);e.add(r),t.delete(r),i=c}},j=function(n,e,t,a,i,o){let s=u(this,b);if(t.domain().size()===0)return s;let r=x.fromVariables(e),c=t.domain().at(0);const h=x.fromVariables(e);for(let m=0;m<t.domain().size()&&s<i;++m){const y=t.domain().at(m);t.assign(y);const E=Math.min(a,p(this,d,$).call(this,n,t,s,o));if(E>Math.max(s,o)){const N=new Set,v=Math.min(Math.min(E,i),p(this,d,R).call(this,n,e,t,E,i,N));if(v>s&&(s=v,c=y,r=x.fromVariables(e)),N.size){const I=p(this,d,k).call(this,n,e,t,E,i,N,Math.max(o,s));if(u(this,g)!==-1)return s;I>s&&(s=I,c=y,r=x.fromVariables(e)),h.apply()}}}return r.apply(),t.assign(c),s},k=function(n,e,t,a,i,o,s){const r=p(this,d,A).call(this,e,o),c=_(n,t),h=e.difference(r);return p(this,d,F).call(this,c,h,r,a,Math.min(i,a),s)},B=function(n,e){const t=new Set;for(const i of n)for(const o of i)t.add(o);let a=1;for(const i of t){const o=i.degree();o!==z.UNDEFINED&&o<a&&(a=o)}for(const i of this.pro.constraints())i.lowestConsistencyDegree()<u(this,w)&&e.add(i);return a},$=function(n,e,t,a){let i=1;const o=new Set;for(const s of n){const r=this.pro.constraintsBetween(s,e);for(const c of r)o.add(c)}for(const s of o){const r=s.degree();if(r!==z.UNDEFINED&&(r<i&&(i=r),i<=t||i<=a))return i}return i},R=function(n,e,t,a,i,o){let s=1;const r=new Set;for(const c of n){const h=this.pro.constraintsBetween(c,t);for(const m of h)r.add(m)}for(const c of e){const h=this.pro.constraintsBetween(c,t);for(const m of h)r.add(m)}for(const c of r){const h=c.degree();h!==z.UNDEFINED&&h<s&&(s=h)}for(const c of r){const h=c.degree();h!==z.UNDEFINED&&(h<a||h<i)&&o.add(c)}return s};function _(f,l){return new Set(f).add(l)}export{J as FlexibleLocalChangesEx};
