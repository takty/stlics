var E=f=>{throw TypeError(f)};var D=(f,a,o)=>a.has(f)||E("Cannot "+o);var u=(f,a,o)=>(D(f,a,"read from private field"),o?o.call(f):a.get(f)),S=(f,a,o)=>a.has(f)?E("Cannot add the same private member more than once"):a instanceof WeakSet?a.add(f):a.set(f,o),x=(f,a,o,s)=>(D(f,a,"write to private field"),s?s.call(f,o):a.set(f,o),o),m=(f,a,o)=>(D(f,a,"access private method"),o);var A=(f,a,o,s)=>({set _(t){x(f,a,t,o)},get _(){return u(f,a,s)}});import{S as _,A as z}from"./assignment-list-Cz8wSDvM.js";import{c as N,l as O}from"./consistency-CCCPNVtk.js";import"./worker-Db_QFRP6.js";var b,w,V,g,d,v,j,L,$,F,R,T;class J extends _{constructor(){super();S(this,d);S(this,b);S(this,w);S(this,V);S(this,g)}name(){return"Flexible Local Changes Ex"}preprocess(){[A(this,w)._,A(this,b)._]=N(this.pro),x(this,V,this.pro.degree()),this.pro.emptyVariableSize()===0&&this.pro.clearAllVariables(),x(this,g,-1),this.monitor.initialize()}exec(){const o=new Set,s=new Set,t=new Set;for(const p of this.pro.variables())(p.isEmpty()?t:s).add(p);const l=new Set,i=m(this,d,F).call(this,s,l);let n,e=null;t.size===0?(n=i,e=z.fromVariables(s)):n=u(this,w);const r=m(this,d,v).call(this,s,l).union(t),c=s.difference(r);let h=m(this,d,j).call(this,o,c,r,u(this,b),u(this,b),n);return h<n&&e!==null&&e.apply(),h=this.pro.degree(),u(this,V)<h&&0<h&&(u(this,g)!==0||this.monitor.getTarget()===null)}}b=new WeakMap,w=new WeakMap,V=new WeakMap,g=new WeakMap,d=new WeakSet,v=function(o,s){const t=new Map;for(const n of s)if(n.isDefined())for(const e of n)t.has(e)?t.set(e,(t.get(e)??0)+1):t.set(e,1);const l=[...o];l.sort((n,e)=>{let r=0,c=0;return t.has(n)&&(r=t.get(n)??0),t.has(e)&&(c=t.get(e)??0),r<c?1:c<r?-1:0});const i=new Set;for(const n of l){let e=!1;for(const r of s)if(r.isDefined()){e=!0;break}if(!e)break;n.clear(),i.add(n)}return i},j=function(o,s,t,l,i,n){for(s=new Set(s),t=new Set(t);;){this.monitor.outputDebugString(`X1 ${o.size}, X2' ${s.size}, X3' ${t.size}`);const e=this.monitor.check(this.pro.degree());if(e!==null)return x(this,g,e?1:0),i;if(t.size===0)return i;const r=t.values().next().value,c=m(this,d,L).call(this,o,s,r,l,i,n);if(u(this,g)!==-1)return i;if(c<n)return u(this,w);s.add(r),t.delete(r),i=c}},L=function(o,s,t,l,i,n){let e=u(this,w);if(t.domain().size()===0)return e;let r=z.fromVariables(s),c=t.domain().at(0);const h=z.fromVariables(s);for(let p=0;p<t.domain().size()&&e<i;++p){const M=t.domain().at(p);t.assign(M);const y=Math.min(l,m(this,d,R).call(this,o,t,e,n));if(Math.max(e,n)<y){const C=new Set,k=Math.min(Math.min(y,i),m(this,d,T).call(this,o,s,t,y,i,C));if(e<k&&(e=k,c=M,r=z.fromVariables(s)),C.size){const B=m(this,d,$).call(this,o,s,t,y,i,C,Math.max(n,e));if(u(this,g)!==-1)return e;e<B&&(e=B,c=M,r=z.fromVariables(s)),h.apply()}}}return r.apply(),t.assign(c),e},$=function(o,s,t,l,i,n,e){const r=m(this,d,v).call(this,s,n),c=P(o,t),h=s.difference(r);return m(this,d,j).call(this,c,h,r,l,Math.min(i,l),e)},F=function(o,s){const t=new Set;for(const i of o)for(const n of i)t.add(n);let l=1;for(const i of t){const n=i.degree();n<0||n<l&&(l=n)}for(const i of this.pro.constraints())O(i)<u(this,b)&&s.add(i);return l},R=function(o,s,t,l){let i=1;const n=new Set;for(const e of o){const r=this.pro.constraintsBetween(e,s);for(const c of r)n.add(c)}for(const e of n){const r=e.degree();if(!(r<0)&&(r<i&&(i=r),i<=t||i<=l))return i}return i},T=function(o,s,t,l,i,n){let e=1;const r=new Set;for(const c of o){const h=this.pro.constraintsBetween(c,t);for(const p of h)r.add(p)}for(const c of s){const h=this.pro.constraintsBetween(c,t);for(const p of h)r.add(p)}for(const c of r){const h=c.degree();h<0||h<e&&(e=h)}for(const c of r){const h=c.degree();h<0||(h<l||h<i)&&n.add(c)}return e};function P(f,a){return new Set(f).add(a)}export{J as FlexibleLocalChangesEx};
