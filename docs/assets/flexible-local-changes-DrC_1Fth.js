var L=c=>{throw TypeError(c)};var A=(c,l,e)=>l.has(c)||L("Cannot "+e);var u=(c,l,e)=>(A(c,l,"read from private field"),e?e.call(c):l.get(c)),D=(c,l,e)=>l.has(c)?L("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(c):l.set(c,e),S=(c,l,e,s)=>(A(c,l,"write to private field"),s?s.call(c,e):l.set(c,e),e),p=(c,l,e)=>(A(c,l,"access private method"),e);var M=(c,l,e,s)=>({set _(t){S(c,l,t,e)},get _(){return u(c,l,s)}});import{C as y}from"./worker-CtBaVZDz.js";import{S as _,A as x}from"./assignment-list-e_PpAs4R.js";var b,w,C,g,h,j,F,E,k,B,$,R,T;class K extends _{constructor(){super();D(this,h);D(this,b);D(this,w);D(this,C);D(this,g)}name(){return"Flexible Local Changes"}preprocess(){[M(this,w)._,M(this,b)._]=p(this,h,j).call(this),S(this,C,this.pro.degree()),this.pro.emptyVariableSize()===0&&this.pro.clearAllVariables(),S(this,g,-1),this.monitor.initialize()}exec(){const e=new Set,s=new Set,t=new Set;for(const m of this.pro.variables())(m.isEmpty()?t:s).add(m);const a=new Set,i=p(this,h,$).call(this,s,a);let o,n=null;t.size===0?(o=i,n=x.fromVariables(s)):o=u(this,w);const r=p(this,h,F).call(this,s,a).union(t),f=s.difference(r);let d=p(this,h,E).call(this,e,f,r,u(this,b),u(this,b),o);return d<o&&n!==null&&n.apply(),d=this.pro.degree(),d>u(this,C)&&d>0&&(u(this,g)!==0||this.monitor.getTarget()===null)}}b=new WeakMap,w=new WeakMap,C=new WeakMap,g=new WeakMap,h=new WeakSet,j=function(){let e=1,s=0;for(const t of this.pro.variables())for(const a of t){const i=a.lowestConsistencyDegree(),o=a.highestConsistencyDegree();i<e&&(e=i),o>s&&(s=o)}return[e,s]},F=function(e,s){const t=new Map;for(const o of s)if(o.isDefined())for(const n of o)t.has(n)?t.set(n,(t.get(n)??0)+1):t.set(n,1);const a=[...e];a.sort((o,n)=>{let r=0,f=0;return t.has(o)&&(r=t.get(o)??0),t.has(n)&&(f=t.get(n)??0),r<f?1:r>f?-1:0});const i=new Set;for(const o of a){let n=!1;for(const r of s)if(r.isDefined()){n=!0;break}if(!n)break;o.clear(),i.add(o)}return i},E=function(e,s,t,a,i,o){{this.monitor.outputDebugString(`X1 ${e.size}, X2' ${s.size}, X3' ${t.size}`);const n=this.monitor.check(this.pro.degree());if(n!==null)return S(this,g,n?1:0),i;if(t.size===0)return i;const r=t.values().next().value,f=p(this,h,k).call(this,e,s,r,a,i,o);return u(this,g)!==-1?i:f<o?u(this,w):(s=U(s,r),t=H(t,r),p(this,h,E).call(this,e,s,t,a,f,o))}},k=function(e,s,t,a,i,o){let n=u(this,w);if(t.domain().size()===0)return n;let r=x.fromVariables(s),f=t.domain().at(0);const d=x.fromVariables(s);for(let m=0;m<t.domain().size()&&n<i;++m){const N=t.domain().at(m);t.assign(N);const z=Math.min(a,p(this,h,R).call(this,e,t,n,o));if(z>Math.max(n,o)){const V=new Set,v=Math.min(Math.min(z,i),p(this,h,T).call(this,e,s,t,z,i,V));if(v>n&&(n=v,f=N,r=x.fromVariables(s)),V.size){const I=p(this,h,B).call(this,e,s,t,z,i,V,Math.max(o,n));if(u(this,g)!==-1)return n;I>n&&(n=I,f=N,r=x.fromVariables(s)),d.apply()}}}return r.apply(),t.assign(f),n},B=function(e,s,t,a,i,o,n){const r=p(this,h,F).call(this,s,o),f=U(e,t),d=s.difference(r);return p(this,h,E).call(this,f,d,r,a,Math.min(i,a),n)},$=function(e,s){const t=new Set;for(const i of e)for(const o of i)t.add(o);let a=1;for(const i of t){const o=i.degree();o!==y.UNDEFINED&&o<a&&(a=o)}for(const i of this.pro.constraints())i.lowestConsistencyDegree()<u(this,b)&&s.add(i);return a},R=function(e,s,t,a){let i=1;const o=new Set;for(const n of e){const r=this.pro.constraintsBetween(n,s);for(const f of r)o.add(f)}for(const n of o){const r=n.degree();if(r!==y.UNDEFINED&&(r<i&&(i=r),i<=t||i<=a))return i}return i},T=function(e,s,t,a,i,o){let n=1;const r=new Set;for(const f of e){const d=this.pro.constraintsBetween(f,t);for(const m of d)r.add(m)}for(const f of s){const d=this.pro.constraintsBetween(f,t);for(const m of d)r.add(m)}for(const f of r){const d=f.degree();d!==y.UNDEFINED&&d<n&&(n=d)}for(const f of r){const d=f.degree();d!==y.UNDEFINED&&(d<a||d<i)&&o.add(f)}return n};function U(c,l){return new Set(c).add(l)}function H(c,l){const e=new Set(c);return e.delete(l),e}export{K as FlexibleLocalChanges};
